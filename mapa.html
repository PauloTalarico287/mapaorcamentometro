<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Execu√ß√£o Or√ßament√°ria - Subprefeituras SP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f5f5f5;
      }
      #container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        background: white;
        padding: 30px;
        border-radius: 0px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #666;
        font-size: 16px;
      }

      /* ‚úÖ LAYOUT LADO A LADO */
      .main-content {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      /* ‚úÖ PAINEL LATERAL FIXO */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .controls-panel {
        background: white;
        padding: 20px;
        border-radius: 0px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
      }

      .controls-panel h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 8px;
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        display: block;
        margin-bottom: 8px;
      }

      .search-box {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 0px;
        font-size: 15px;
        transition: border-color 0.3s;
      }

      .search-box:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .filter-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filter-btn {
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 0px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        text-align: left;
      }

      .filter-btn:hover {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      .filter-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .filter-btn-content {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-btn .badge {
        background: rgba(0, 0, 0, 0.1);
        padding: 3px 8px;
        border-radius: 0px;
        font-size: 12px;
        min-width: 30px;
        text-align: center;
      }

      .filter-btn.active .badge {
        background: rgba(255, 255, 255, 0.3);
      }

      .reset-btn {
        width: 100%;
        padding: 12px 20px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 0px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
        font-size: 14px;
      }

      .reset-btn:hover {
        background: #dc2626;
      }

      .results-info {
        background: #f0f9ff;
        padding: 12px;
        border-radius: 0px;
        border-left: 4px solid #3b82f6;
        font-size: 13px;
        color: #1e40af;
        margin-top: 15px;
      }

      /* ‚úÖ MAPA EM TELA CHEIA */
      #map {
        height: calc(100vh - 40px);
        min-height: 600px;
        border-radius: 0px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 20px;
      }

      /* ‚úÖ POPUPS MELHORADOS - FECHAM AUTOMATICAMENTE */
      .leaflet-popup-close-button {
        font-size: 24px !important;
        padding: 4px 8px !important;
        color: #666 !important;
      }

      .leaflet-popup-close-button:hover {
        color: #ef4444 !important;
      }

      .info-box {
        background: white;
        padding: 15px;
        border-radius: 0px;
        min-width: 250px;
      }
      .info-box h4 {
        margin-bottom: 10px;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
      }
      .info-item {
        margin: 8px 0;
        font-size: 14px;
      }
      .info-label {
        font-weight: 600;
        color: #555;
      }
      .exec-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 00px;
        font-weight: bold;
        font-size: 16px;
        margin-top: 5px;
      }
      .exec-total {
        background: #059669;
        color: white;
      }
      .exec-perto {
        background: #10b981;
        color: white;
      }
      .exec-razoavel {
        background: #3b82f6;
        color: white;
      }
      .exec-um-terco {
        background: #f59e0b;
        color: white;
      }
      .exec-baixo {
        background: #ef4444;
        color: white;
      }
      .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: #666;
      }

      .legend {
        background: white;
        padding: 20px;
        border-radius: 0px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .legend h3 {
        margin-bottom: 15px;
        color: #333;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .legend-color {
        width: 40px;
        height: 25px;
        margin-right: 10px;
        border-radius: 0px;
        border: 1px solid #ddd;
      }

      /* ‚úÖ RESPONSIVIDADE */
      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .controls-panel {
          position: relative;
          top: 0;
          max-height: none;
        }

        #map {
          position: relative;
          top: 0;
          height: 600px;
        }
      }

      @media (max-width: 768px) {
        #container {
          padding: 10px;
        }

        header {
          padding: 20px;
        }

        h1 {
          font-size: 22px;
        }

        .main-content {
          gap: 10px;
        }

        #map {
          height: 500px;
        }
      }

      /* ‚úÖ DESTAQUE AO PASSAR O MOUSE NO MARCADOR */
      .building-marker:hover {
        transform: scale(1.2) !important;
        filter: brightness(1.1);
        z-index: 1000 !important;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <header>
        <h1>Execu√ß√£o Or√ßament√°ria das Subprefeituras de S√£o Paulo - 2025</h1>
        <p class="subtitle">
          Use os filtros ao lado para explorar os dados ‚Ä¢ Clique nos marcadores
          para ver detalhes
        </p>
      </header>

      <!-- ‚úÖ LAYOUT LADO A LADO -->
      <div class="main-content">
        <!-- PAINEL LATERAL -->
        <div class="sidebar">
          <div class="controls-panel">
            <h3 style="display: flex; align-items: center; gap: 0.5rem">
              <img
                src="https://cdn.agenciamural.org.br/2026/01/23131054/buscar.png"
                alt="Filtros"
                style="width: 24px; height: 24px"
              />
              Filtros e Busca
            </h3>

            <!-- Busca por Nome -->
            <div class="control-group">
              <label for="search-input">Buscar Subprefeitura</label>
              <input
                type="text"
                id="search-input"
                class="search-box"
                placeholder="Ex: S√©, Vila Mariana..."
              />
              <small
                style="
                  color: #666;
                  font-size: 11px;
                  margin-top: 4px;
                  display: block;
                "
              >
                üí° Pressione ESC para limpar
              </small>
            </div>

            <!-- Filtro por Faixa de Execu√ß√£o -->
            <div class="control-group">
              <label>N√≠vel de Execu√ß√£o</label>
              <div class="filter-buttons">
                <button class="filter-btn" data-filter="all">
                  <div class="filter-btn-content">
                    <span>Todas</span>
                  </div>
                  <span class="badge" id="count-all">0</span>
                </button>
                <button class="filter-btn" data-filter="total">
                  <div class="filter-btn-content">
                    <span
                      style="
                        width: 14px;
                        height: 14px;
                        background: #059669;
                        border-radius: 0%;
                        display: inline-block;
                      "
                    ></span>
                    <span>100% ou mais</span>
                  </div>
                  <span class="badge" id="count-total">0</span>
                </button>
                <button class="filter-btn" data-filter="perto">
                  <div class="filter-btn-content">
                    <span
                      style="
                        width: 14px;
                        height: 14px;
                        background: #10b981;
                        border-radius: 0%;
                        display: inline-block;
                      "
                    ></span>
                    <span>86% a 99%</span>
                  </div>
                  <span class="badge" id="count-perto">0</span>
                </button>
                <button class="filter-btn" data-filter="razoavel">
                  <div class="filter-btn-content">
                    <span
                      style="
                        width: 14px;
                        height: 14px;
                        background: #3b82f6;
                        border-radius: 0%;
                        display: inline-block;
                      "
                    ></span>
                    <span>71% a 85%</span>
                  </div>
                  <span class="badge" id="count-razoavel">0</span>
                </button>
                <button class="filter-btn" data-filter="terco">
                  <div class="filter-btn-content">
                    <span
                      style="
                        width: 14px;
                        height: 14px;
                        background: #f59e0b;
                        border-radius: 0%;
                        display: inline-block;
                      "
                    ></span>
                    <span>51% a 70%</span>
                  </div>
                  <span class="badge" id="count-terco">0</span>
                </button>
                <button class="filter-btn" data-filter="baixo">
                  <div class="filter-btn-content">
                    <span
                      style="
                        width: 14px;
                        height: 14px;
                        background: #ef4444;
                        border-radius: 0%;
                        display: inline-block;
                      "
                    ></span>
                    <span>Menos de 51%</span>
                  </div>
                  <span class="badge" id="count-baixo">0</span>
                </button>
              </div>
            </div>

            <button class="reset-btn" onclick="resetarFiltros()">
              üîÑ Limpar Todos os Filtros
            </button>

            <div class="results-info" id="results-info">
              Mostrando todas as 32 subprefeituras
            </div>
          </div>

          <!-- LEGENDA ABAIXO DOS FILTROS -->
          <div class="legend">
            <h3 style="display: flex; align-items: center; gap: 0.5rem">
              <img
                src="https://cdn.agenciamural.org.br/2026/01/23131052/execucao-orcametaria.png"
                alt="Legenda"
                style="width: 24px; height: 24px"
              />
              Legenda
            </h3>
            <div class="legend-item">
              <div class="legend-color" style="background: #059669"></div>
              <span style="font-size: 13px"
                ><strong>100%+</strong> Totalmente realizado</span
              >
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #10b981"></div>
              <span style="font-size: 13px"
                ><strong>86-99%</strong> Perto do total</span
              >
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #3b82f6"></div>
              <span style="font-size: 13px"
                ><strong>71-85%</strong> Razo√°vel</span
              >
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f59e0b"></div>
              <span style="font-size: 13px"
                ><strong>51-70%</strong> Um ter√ßo n√£o usado</span
              >
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #ef4444"></div>
              <span style="font-size: 13px"
                ><strong>&lt;51%</strong> Menos da metade</span
              >
            </div>
          </div>
        </div>

        <!-- MAPA -->
        <div id="map">
          <div class="loading">‚è≥ Carregando dados da planilha...</div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
      const SHEET_URL =
        "https://docs.google.com/spreadsheets/d/1hURqGNnl9k4A_KhsQ4RvphmPGsJPlhq5NZpLnox0SUY/export?format=csv&gid=0";

      // Coordenadas das subprefeituras
      const coordenadas = {
        Mooca: { lat: -23.5491, lng: -46.5964 },
        Parelheiros: { lat: -23.7774, lng: -46.6997 },
        S√©: { lat: -23.5505, lng: -46.6333 },
        Guaianases: { lat: -23.5398, lng: -46.4144 },
        Ipiranga: { lat: -23.5928, lng: -46.6078 },
        Lapa: { lat: -23.5281, lng: -46.7023 },
        Penha: { lat: -23.5289, lng: -46.5431 },
        "Santo Amaro": { lat: -23.6528, lng: -46.7079 },
        "Itaim Paulista": { lat: -23.5008, lng: -46.4028 },
        "Pirituba/Jaragu√°": { lat: -23.4877, lng: -46.7279 },
        "Cidade Tiradentes": { lat: -23.5964, lng: -46.4021 },
        "Cidade Ademar": { lat: -23.6632, lng: -46.6543 },
        "Freguesia do √ì/Brasil√¢ndia": { lat: -23.4799, lng: -46.6938 },
        "Ermelino Matarazzo": { lat: -23.4997, lng: -46.4778 },
        Pinheiros: { lat: -23.5629, lng: -46.6823 },
        "Casa Verde": { lat: -23.4806, lng: -46.6486 },
        "Vila Mariana": { lat: -23.5949, lng: -46.6392 },
        "Capela do Socorro": { lat: -23.7725, lng: -46.7465 },
        Jabaquara: { lat: -23.6427, lng: -46.6405 },
        "M'Boi Mirim": { lat: -23.6545, lng: -46.7687 },
        "S√£o Miguel": { lat: -23.4983, lng: -46.4396 },
        "Vila Prudente": { lat: -23.5854, lng: -46.5776 },
        "Aricanduva/Vila Formosa": { lat: -23.5557, lng: -46.5125 },
        "Ja√ßan√£/Trememb√©": { lat: -23.4681, lng: -46.613 },
        Itaquera: { lat: -23.5401, lng: -46.4561 },
        "Santana/Tucuruvi": { lat: -23.509, lng: -46.6259 },
        Butant√£: { lat: -23.5776, lng: -46.7269 },
        Sapopemba: { lat: -23.6131, lng: -46.5063 },
        "Vila Maria/Vila Guilherme": { lat: -23.5079, lng: -46.5862 },
        "Campo Limpo": { lat: -23.6458, lng: -46.766 },
        "S√£o Mateus": { lat: -23.6067, lng: -46.4753 },
        Perus: { lat: -23.4008, lng: -46.7473 },
      };

      // ‚úÖ VARI√ÅVEIS GLOBAIS
      let map;
      let markers = [];
      let dadosCompletos = [];
      let filtroAtivo = "all";
      let buscaAtiva = "";
      let popupAberto = null;

      function formatarValor(valor) {
        return new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
          minimumFractionDigits: 2,
        }).format(valor);
      }

      function getColor(exec) {
        if (exec >= 100) return "#059669";
        if (exec >= 86) return "#10b981";
        if (exec >= 71) return "#3b82f6";
        if (exec >= 51) return "#f59e0b";
        return "#ef4444";
      }

      function getExecClass(exec) {
        if (exec >= 100) return "exec-total";
        if (exec >= 86) return "exec-perto";
        if (exec >= 71) return "exec-razoavel";
        if (exec >= 51) return "exec-um-terco";
        return "exec-baixo";
      }

      function getExecLabel(exec) {
        if (exec >= 100) return "Totalmente realizado";
        if (exec >= 86) return "Perto do total";
        if (exec >= 71) return "Execu√ß√£o razo√°vel";
        if (exec >= 51) return "Um ter√ßo n√£o usado";
        return "Menos da metade";
      }

      function getExecCategory(exec) {
        if (exec >= 100) return "total";
        if (exec >= 86) return "perto";
        if (exec >= 71) return "razoavel";
        if (exec >= 51) return "terco";
        return "baixo";
      }

      function parseValor(str) {
        if (!str) return 0;
        return (
          parseFloat(
            str
              .toString()
              .replace(/[^\d,-]/g, "")
              .replace(",", ".")
          ) || 0
        );
      }

      // ‚úÖ FUN√á√ÉO PARA NORMALIZAR TEXTO
      function normalizeText(text) {
        return text
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim();
      }

      // ‚úÖ FUN√á√ÉO PARA ATUALIZAR CONTADORES
      function atualizarContadores() {
        const contadores = {
          all: 0,
          total: 0,
          perto: 0,
          razoavel: 0,
          terco: 0,
          baixo: 0,
        };

        dadosCompletos.forEach((d) => {
          contadores.all++;
          contadores[getExecCategory(d.executado)]++;
        });

        Object.keys(contadores).forEach((key) => {
          const el = document.getElementById(`count-${key}`);
          if (el) el.textContent = contadores[key];
        });
      }

      // ‚úÖ FUN√á√ÉO PARA APLICAR FILTROS
      function aplicarFiltros() {
        let dadosFiltrados = dadosCompletos;

        // Filtro por categoria
        if (filtroAtivo !== "all") {
          dadosFiltrados = dadosFiltrados.filter(
            (d) => getExecCategory(d.executado) === filtroAtivo
          );
        }

        // Filtro por busca
        if (buscaAtiva && buscaAtiva.trim() !== "") {
          const buscaNormalizada = normalizeText(buscaAtiva);
          dadosFiltrados = dadosFiltrados.filter((d) => {
            const nomeNormalizado = normalizeText(d.nome);
            return nomeNormalizado.includes(buscaNormalizada);
          });
        }

        // Atualizar marcadores
        markers.forEach((markerObj) => {
          const visivel = dadosFiltrados.some((d) => d.nome === markerObj.nome);
          if (visivel) {
            if (!map.hasLayer(markerObj.marker)) {
              markerObj.marker.addTo(map);
            }
          } else {
            if (map.hasLayer(markerObj.marker)) {
              map.removeLayer(markerObj.marker);
            }
          }
        });

        // Atualizar info de resultados
        const info = document.getElementById("results-info");
        if (dadosFiltrados.length === dadosCompletos.length) {
          info.textContent = `Mostrando todas as ${dadosCompletos.length} subprefeituras`;
          info.style.background = "#f0f9ff";
          info.style.borderColor = "#3b82f6";
          info.style.color = "#1e40af";
        } else if (dadosFiltrados.length === 0) {
          info.textContent = `‚ùå Nenhuma subprefeitura encontrada`;
          info.style.background = "#fef2f2";
          info.style.borderColor = "#ef4444";
          info.style.color = "#991b1b";
        } else {
          info.textContent = `‚úÖ Mostrando ${dadosFiltrados.length} de ${dadosCompletos.length} subprefeituras`;
          info.style.background = "#f0fdf4";
          info.style.borderColor = "#22c55e";
          info.style.color = "#166534";
        }

        // Ajustar zoom
        if (dadosFiltrados.length === 1) {
          const coords = coordenadas[dadosFiltrados[0].nome];
          if (coords) {
            setTimeout(() => {
              map.flyTo([coords.lat, coords.lng], 13, { duration: 1 });
              markers.forEach((m) => {
                if (m.nome === dadosFiltrados[0].nome) {
                  m.marker.openPopup();
                }
              });
            }, 100);
          }
        } else if (
          dadosFiltrados.length > 1 &&
          dadosFiltrados.length < dadosCompletos.length
        ) {
          const bounds = dadosFiltrados
            .map((d) => coordenadas[d.nome])
            .filter((c) => c)
            .map((c) => [c.lat, c.lng]);

          if (bounds.length > 0) {
            setTimeout(() => {
              map.flyToBounds(bounds, {
                padding: [80, 80],
                duration: 1,
                maxZoom: 12,
              });
            }, 100);
          }
        }
      }

      // ‚úÖ FUN√á√ÉO PARA RESETAR FILTROS
      function resetarFiltros() {
        filtroAtivo = "all";
        buscaAtiva = "";
        document.getElementById("search-input").value = "";

        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector('.filter-btn[data-filter="all"]')
          .classList.add("active");

        map.flyTo([-23.5505, -46.6333], 11, { duration: 1 });
        aplicarFiltros();
      }

      function initMap(dados) {
        document.querySelector(".loading").remove();

        dadosCompletos = dados;

        map = L.map("map").setView([-23.5505, -46.6333], 11);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
        }).addTo(map);

        // ‚úÖ FECHAR POPUP AO CLICAR NO MAPA
        map.on("click", function () {
          map.closePopup();
        });

        dados.forEach((d) => {
          const coords = coordenadas[d.nome];
          if (!coords) return;

          const buildingIcon = L.divIcon({
            className: "building-marker",
            html: `<div style="
                      width: 24px;
                      height: 32px;
                      background: linear-gradient(to bottom, ${getColor(
                        d.executado
                      )} 0%, ${getColor(d.executado)} 70%, #333 70%, #333 100%);
                      border: 2px solid #fff;
                      border-bottom: none;
                      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
                      position: relative;
                      transform: translate(-50%, -100%);
                      cursor: pointer;
                      transition: all 0.2s;
                  ">
                      <div style="
                          position: absolute;
                          top: 3px;
                          left: 3px;
                          right: 3px;
                          display: grid;
                          grid-template-columns: 1fr 1fr;
                          gap: 2px;
                      ">
                          <div style="width: 6px; height: 5px; background: rgba(255,255,255,0.4);"></div>
                          <div style="width: 6px; height: 5px; background: rgba(255,255,255,0.4);"></div>
                          <div style="width: 6px; height: 5px; background: rgba(255,255,255,0.4);"></div>
                          <div style="width: 6px; height: 5px; background: rgba(255,255,255,0.4);"></div>
                          <div style="width: 6px; height: 5px; background: rgba(255,255,255,0.4);"></div>
                          <div style="width: 6px; height: 5px; background: rgba(255,255,255,0.4);"></div>
                      </div>
                      <div style="
                          position: absolute;
                          bottom: -6px;
                          left: 50%;
                          transform: translateX(-50%);
                          width: 0;
                          height: 0;
                          border-left: 12px solid transparent;
                          border-right: 12px solid transparent;
                          border-top: 6px solid #333;
                      "></div>
                  </div>`,
            iconSize: [24, 38],
            iconAnchor: [12, 38],
          });

          const marker = L.marker([coords.lat, coords.lng], {
            icon: buildingIcon,
          }).addTo(map);

          markers.push({ nome: d.nome, marker: marker });

          const popupContent = `
                  <div class="info-box">
                      <h4>${d.nome}</h4>
                      <div class="info-item">
                          <span class="info-label">Execu√ß√£o:</span>
                          <span class="exec-badge ${getExecClass(
                            d.executado
                          )}">${d.executado.toFixed(1)}% - ${getExecLabel(
            d.executado
          )}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Previsto 2025:</span> ${formatarValor(
                            d.valorPrevisto
                          )}
                      </div>
                      <div class="info-item">
                          <span class="info-label">Or√ßado Atualizado:</span> ${formatarValor(
                            d.valorOrcado
                          )}
                      </div>
                      <div class="info-item">
                          <span class="info-label">Realizado:</span> ${formatarValor(
                            d.realizado
                          )}    
                  </div>
              `;

          // ‚úÖ CONFIGURAR POPUP PARA FECHAR AO CLICAR EM OUTRO
          marker.bindPopup(popupContent, {
            maxWidth: 300,
            closeButton: true,
            autoClose: true, // ‚úÖ Fecha automaticamente ao abrir outro
            closeOnClick: false, // ‚úÖ N√£o fecha ao clicar no mapa (controlado manualmente)
          });

          // ‚úÖ ABRIR NO HOVER
          marker.on("mouseover", function () {
            this.openPopup();
          });

          // ‚úÖ N√ÉO FECHAR NO MOUSEOUT (deixa aberto para navega√ß√£o)
          // Vai fechar apenas ao clicar em outro marcador ou no mapa
        });

        atualizarContadores();

        // ‚úÖ EVENT LISTENERS DOS FILTROS
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            filtroAtivo = this.dataset.filter;
            aplicarFiltros();
          });
        });

        document
          .querySelector('.filter-btn[data-filter="all"]')
          .classList.add("active");

        // ‚úÖ EVENT LISTENER DA BUSCA
        let searchTimeout;
        document
          .getElementById("search-input")
          .addEventListener("input", function (e) {
            clearTimeout(searchTimeout);
            buscaAtiva = e.target.value;

            searchTimeout = setTimeout(() => {
              aplicarFiltros();
            }, 300);
          });

        document
          .getElementById("search-input")
          .addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
              this.value = "";
              buscaAtiva = "";
              aplicarFiltros();
            }
          });
      }

      // Carregar dados da planilha
      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const dados = results.data
            .filter((row) => {
              const orgao = row["√ìrg√£o"] || row["Org√£o"] || row["ORG√ÉO"];
              return orgao && coordenadas[orgao];
            })
            .map((row) => {
              const orgao = row["√ìrg√£o"] || row["Org√£o"] || row["ORG√ÉO"];
              return {
                nome: orgao,
                valorPrevisto: parseValor(row["Valor previsto para 2025"]),
                valorOrcado: parseValor(row["Valor Or√ßado Atualizado"]),
                valorCongelado: parseValor(row["Valor Congelado"]),
                valorDescongelado: parseValor(row["Valor Descongelado"]),
                realizado: parseValor(row["Realizado"]),
                executado: parseFloat(row["Executado (%)"]) || 0,
              };
            });

          if (dados.length === 0) {
            document.querySelector(".loading").innerHTML =
              "‚ùå Nenhum dado encontrado.";
          } else {
            initMap(dados);
          }
        },
        error: function (error) {
          document.querySelector(".loading").innerHTML =
            "‚ùå Erro ao carregar dados da planilha.";
          console.error("Erro:", error);
        },
      });
    </script>
  </body>
</html>
